<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GPS Tracker Pro + Google Sheets Markers</title>

  <!-- Leaflet CSS (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà integrity ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á SRI error) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --btn: #007bff;
      --btn-hover: #0056b3;
      --ok: #28a745;
      --ok-hover: #1e7e34;
      --info: #17a2b8;
      --info-hover: #117a8b;
      --warn: #ffc107;
      --warn-text: #000;
      --danger: #dc3545;
      --danger-hover: #a71d2a;
    }
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f5f6fa;
    }
    #map { height: 100vh; width: 100%; z-index: 1; }

    /* ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á */
    .control-panel {
      position: fixed; top: 12px; left: 12px; z-index: 1500;
      display: flex; flex-direction: column; gap: 8px;
    }
    .control-panel button {
      border: 0; border-radius: 10px; padding: 10px 14px;
      color: #fff; font-size: 14px; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
      transition: background .2s ease;
    }
    #startBtn { background: var(--btn); }
    #startBtn:hover { background: var(--btn-hover); }
    #stopBtn { background: #6c757d; }
    #saveBtn { background: var(--ok); }
    #saveBtn:hover { background: var(--ok-hover); }
    #gpxBtn { background: var(--info); }
    #gpxBtn:hover { background: var(--info-hover); }
    #importBtn { background: var(--warn); color: var(--warn-text); }
    #clearBtn { background: var(--danger); }
    #clearBtn:hover { background: var(--danger-hover); }

    /* ‡∏õ‡∏∏‡πà‡∏° Refresh ‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
    .refresh-btn {
      position: fixed; top: 12px; right: 12px; z-index: 1500;
      background: var(--btn); color: #fff; border: 0; border-radius: 10px;
      padding: 10px 14px; font-size: 14px; font-weight: 700;
      cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,.25);
    }
    .refresh-btn:hover { background: var(--btn-hover); }

    /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .status-bar {
      position: fixed; bottom: 10px; left: 10px; z-index: 1200;
      background: rgba(255,255,255,.95);
      padding: 10px 14px; border-radius: 10px; font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.25); line-height: 1.45;
      max-width: 92vw;
    }

    /* Legend ‡∏™‡∏µ */
    .legend {
      position: fixed; bottom: 20px; right: 20px; z-index: 1200;
      background: rgba(255,255,255,.95); padding: 10px 12px; border-radius: 10px;
      font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,.25); line-height: 1.6;
    }
    .legend div { display: flex; align-items: center; gap: 6px; }
    .legend-color {
      width: 14px; height: 14px; border-radius: 50%;
      border: 1px solid #666; flex-shrink: 0;
    }

    /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    @media (max-width: 600px) {
      .control-panel button { padding: 8px 12px; font-size: 13px; }
      .refresh-btn { padding: 8px 12px; font-size: 13px; top: 10px; right: 10px; }
      .status-bar { font-size: 12px; bottom: 8px; left: 8px; padding: 8px 10px; }
      .legend { font-size: 12px; bottom: 70px; right: 8px; padding: 8px 10px; }
      .legend-color { width: 12px; height: 12px; }
      .leaflet-popup-content { font-size: 13px; }
    }
  </style>
</head>
<body>

  <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
  <div class="control-panel">
    <button id="startBtn">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</button>
    <button id="stopBtn" disabled>‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</button>
    <button id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (JSON)</button>
    <button id="gpxBtn">‚¨áÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (GPX)</button>
    <button id="importBtn">üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
    <button id="clearBtn">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <input type="file" id="fileInput" accept=".json" style="display:none;">
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets -->
  <button id="refreshBtn" class="refresh-btn">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>

  <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
  <div id="map"></div>

  <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
  <div id="status" class="status-bar">üïì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>

  <!-- Legend ‡∏™‡∏µ -->
  <div class="legend">
    <b>üó∫Ô∏è ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ:</b>
    <div><span class="legend-color" style="background: green;"></span> ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
    <div><span class="legend-color" style="background: orange;"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
    <div><span class="legend-color" style="background: red;"></span> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
    <div><span class="legend-color" style="background: pink;"></span> HM (‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô)</div>
    <div><span class="legend-color" style="background: yellow;"></span> SP (‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô)</div>
    <div><span class="legend-color" style="background: blue;"></span> ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    window.onload = () => {
      /* -----------------------------
         1) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å
      ------------------------------*/
      if (typeof L === "undefined") {
        alert("Leaflet ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return;
      }

      const map = L.map('map', {
        zoomControl: true, attributionControl: true,
        tap: true, inertia: true, maxZoom: 19
      }).setView([13.736717, 100.523186], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const statusEl   = document.getElementById("status");
      const refreshBtn = document.getElementById("refreshBtn");

      // ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå/‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ç‡∏≠‡∏á ‚Äú‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‚Äù
      let userMarker = null, userCircle = null, userPolyline = null;
      let path = []; let totalDistance = 0; let startTime = null; let watchInterval = null;

      // ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á ‚ÄúMarker ‡∏à‡∏≤‡∏Å Google Sheets‚Äù
      const sheetLayer = L.layerGroup().addTo(map);

      /* ---------------------------------------
         2) Util: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (Haversine)
      ----------------------------------------*/
      function calcDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI/180;
        const dLon = (lon2 - lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(lat1*Math.PI/180) *
                  Math.cos(lat2*Math.PI/180) *
                  Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      /* ---------------------------------------
         3) ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
      ----------------------------------------*/
      function updateLocation() {
        if (!navigator.geolocation) {
          alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"); return;
        }
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude, accuracy } = pos.coords;

          // ‡∏•‡∏ö marker/circle ‡πÄ‡∏î‡∏¥‡∏°
          if (userMarker) map.removeLayer(userMarker);
          if (userCircle) map.removeLayer(userCircle);

          // ‡∏ß‡∏≤‡∏á marker ‡πÅ‡∏•‡∏∞‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
          userMarker = L.marker([latitude, longitude], { title: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" }).addTo(map);
          userCircle = L.circle([latitude, longitude], { radius: accuracy }).addTo(map);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
          if (path.length > 0) {
            const [pl, pg] = path[path.length - 1];
            totalDistance += calcDistance(pl, pg, latitude, longitude);
          }
          path.push([latitude, longitude]);

          if (userPolyline) map.removeLayer(userPolyline);
          userPolyline = L.polyline(path, { color: "#007bff", weight: 4 }).addTo(map);

          map.setView([latitude, longitude], 16);

          const elapsed = startTime ? ((Date.now() - startTime)/1000/60).toFixed(1) : 0;
          statusEl.innerHTML =
            `üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>` +
            `üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: ${totalDistance.toFixed(2)} ‡∏Å‡∏°.<br>` +
            `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤: ${elapsed} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }, err => {
          console.error(err);
          statusEl.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: " + err.message;
        }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏•‡πâ‡∏≤‡∏á
      const startBtn  = document.getElementById('startBtn');
      const stopBtn   = document.getElementById('stopBtn');
      const saveBtn   = document.getElementById('saveBtn');
      const gpxBtn    = document.getElementById('gpxBtn');
      const importBtn = document.getElementById('importBtn');
      const clearBtn  = document.getElementById('clearBtn');
      const fileInput = document.getElementById('fileInput');

      startBtn.addEventListener('click', () => {
        if (watchInterval) return;
        path = []; totalDistance = 0; startTime = Date.now();
        statusEl.innerHTML = "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß...";
        updateLocation();
        watchInterval = setInterval(updateLocation, 10000);
        startBtn.disabled = true; stopBtn.disabled = false;
      });

      stopBtn.addEventListener('click', () => {
        if (!watchInterval) return;
        clearInterval(watchInterval); watchInterval = null;
        statusEl.innerHTML += "<br>‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß";
        startBtn.disabled = false; stopBtn.disabled = true;
      });

      saveBtn.addEventListener('click', () => {
        if (path.length === 0) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!"); return; }
        const data = { path, totalDistance, startTime };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `route_${new Date().toISOString().split("T")[0]}.json`; a.click();
        URL.revokeObjectURL(url);
      });

      gpxBtn.addEventListener('click', () => {
        if (path.length === 0) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!"); return; }
        let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        gpx += `<gpx version="1.1" creator="GPS Tracker Pro" xmlns="http://www.topografix.com/GPX/1/1">\n<trk><name>Route</name><trkseg>\n`;
        path.forEach(([lat, lon]) => gpx += `<trkpt lat="${lat}" lon="${lon}"></trkpt>\n`);
        gpx += `</trkseg></trk>\n</gpx>`;
        const blob = new Blob([gpx], { type: "application/gpx+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `route_${new Date().toISOString().split("T")[0]}.gpx`; a.click();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            path = data.path || []; totalDistance = data.totalDistance || 0;
            if (userPolyline) map.removeLayer(userPolyline);
            userPolyline = L.polyline(path, { color: "green", weight: 4 }).addTo(map);
            if (path.length) map.fitBounds(userPolyline.getBounds());
            statusEl.innerHTML = "üìÇ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
          } catch { alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); }
        };
        reader.readAsText(file);
      });

      clearBtn.addEventListener('click', () => {
        if (!confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
        path = []; totalDistance = 0; startTime = null;
        if (userPolyline) map.removeLayer(userPolyline);
        if (userMarker)  map.removeLayer(userMarker);
        if (userCircle)  map.removeLayer(userCircle);
        statusEl.innerHTML = "üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß";
      });

      /* ---------------------------------------
         4) Marker ‡∏à‡∏≤‡∏Å Google Sheets (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ)
      ----------------------------------------*/
      const sheetID  = "1KTFaGCzmtjJtezumsWDXFdsWlpZtSriq2mEHe-ujGNc";
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;
      let firstFitDone = false; // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

      function colorFromStatus(status) {
        const s = (status || "").toString();
        if (/^SP\d+/i.test(s)) return "yellow";
        if (/^HM\d+/i.test(s)) return "pink";
        if (/‡πÄ‡∏™‡∏£‡πá‡∏à/i.test(s))  return "green";
        if (/‡∏Å‡∏≥‡∏•‡∏±‡∏á/i.test(s))  return "orange";
        if (/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà/i.test(s)) return "red";
        return "blue";
      }

      function loadSheetData() {
        statusEl.innerHTML = "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets...";
        fetch(sheetURL)
          .then(res => res.text())
          .then(text => {
            sheetLayer.clearLayers();

            if (!text.startsWith("/*O_o*/")) {
              statusEl.innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)";
              console.error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö feed ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô gviz JSON:", text.slice(0,100));
              return;
            }
            const json = JSON.parse(text.substring(47).slice(0, -2));
            const rows = json.table.rows;

            const markers = [];
            rows.forEach(r => {
              const name       = r.c[0]?.v;
              const lat        = r.c[1]?.v;
              const lng        = r.c[2]?.v;
              const lastRepair = r.c[3]?.v;
              const job        = r.c[4]?.v;
              const tech       = r.c[5]?.v;
              const photo      = r.c[6]?.v;
              const report     = r.c[7]?.v;
              const status     = r.c[8]?.v || "";

              if (lat != null && lng != null) {
                const color = colorFromStatus(status);
                const icon  = L.divIcon({
                  html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid #fff;"></div>`,
                  className: ""
                });
                const popup = `
                  <b>${name ?? "-"}</b><br>
                  üìÖ ${lastRepair || "-"}<br>
                  üõ†Ô∏è ${job || "-"}<br>
                  üë∑ ${tech || "-"}<br>
                  üì∏ <a href="${photo || '#'}" target="_blank">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</a><br>
                  üìÑ <a href="${report || '#'}" target="_blank">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</a><br>
                  üî∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${status || "-"}</b>
                `;
                const m = L.marker([lat, lng], { icon }).bindPopup(popup);
                m.addTo(sheetLayer);
                markers.push(m);
              }
            });

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏Å‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°)
            if (!firstFitDone && markers.length) {
              const group = L.featureGroup(markers);
              map.fitBounds(group.getBounds());
              firstFitDone = true;
            }

            statusEl.innerHTML = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString();
          })
          .catch(err => {
            console.error("‡πÇ‡∏´‡∏•‡∏î Google Sheets ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
            statusEl.innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
          });
      }

      // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
      loadSheetData();
      setInterval(loadSheetData, 300000);

      // ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‚Äù
      refreshBtn.addEventListener("click", () => {
        refreshBtn.disabled = true;
        refreshBtn.innerText = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...";
        loadSheetData();
        setTimeout(() => {
          refreshBtn.disabled = false;
          refreshBtn.innerText = "üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
        }, 2000);
      });
    };
  </script>
</body>
</html>
